<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Transportation analysis in R]]></title>
  <link href="http://aakarner.github.io/atom.xml" rel="self"/>
  <link href="http://aakarner.github.io/"/>
  <updated>2015-03-01T21:05:41-07:00</updated>
  <id>http://aakarner.github.io/</id>
  <author>
    <name><![CDATA[Alex Karner]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Manually Defining a Diverging Legend in Ggplot]]></title>
    <link href="http://aakarner.github.io/blog/2015/02/28/manually-defining-a-diverging-legend-in-ggplot/"/>
    <updated>2015-02-28T22:51:05-07:00</updated>
    <id>http://aakarner.github.io/blog/2015/02/28/manually-defining-a-diverging-legend-in-ggplot</id>
    <content type="html"><![CDATA[<p>I&rsquo;m in the process of mapping some data from the <a href="http://lehd.ces.census.gov/data/">LEHD Origin-Destination Employment Statistics (LODES)</a> helpfully provided by the US Census Bureau. LODES contains information on place of work, place of residence, and flows at the block level. The data are updated annually. As such they&rsquo;re an invaluable resource for studying the commute patterns of demographic groups.</p>

<p>The analysis I&rsquo;m working on is looking at changes over time in number of jobs at the census place level (currently 2009 - 2011). I identified the common locations for the region I&rsquo;m looking at and created an identically structured data frame for each year so that I can easily calculate the difference. Each year of data is identified as <code>wac.place.year</code> where <code>year</code> varies. Identifying all common places is as simple as calling:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>all.places <span class="o">&lt;-</span> <span class="kp">union</span><span class="p">(</span><span class="kp">union</span><span class="p">(</span>wac.place.2011<span class="o">$</span>stplcname<span class="p">,</span> wac.place.2010<span class="o">$</span>stplcname<span class="p">),</span>
</span><span class='line'>  wac.place.2009<span class="o">$</span>stplcname<span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The commonly-structured data frames and differences can be created with the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'><span class="c1"># Create three new (empty) data frames with only common rows between all years</span>
</span><span class='line'>wac.place.2009.v2 <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span><span class="s">&quot;stplcname&quot;</span> <span class="o">=</span> all.places<span class="p">)</span>
</span><span class='line'>wac.place.2010.v2 <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span><span class="s">&quot;stplcname&quot;</span> <span class="o">=</span> all.places<span class="p">)</span>
</span><span class='line'>wac.place.2011.v2 <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span><span class="s">&quot;stplcname&quot;</span> <span class="o">=</span> all.places<span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Populate these data frames using merge (rows with missing info will just get NA)</span>
</span><span class='line'>wac.place.2009.v2 <span class="o">&lt;-</span> <span class="kp">merge</span><span class="p">(</span>wac.place.2009.v2<span class="p">,</span> wac.place.2009<span class="p">,</span> all <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
</span><span class='line'>wac.place.2010.v2 <span class="o">&lt;-</span> <span class="kp">merge</span><span class="p">(</span>wac.place.2010.v2<span class="p">,</span> wac.place.2010<span class="p">,</span> all <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
</span><span class='line'>wac.place.2011.v2 <span class="o">&lt;-</span> <span class="kp">merge</span><span class="p">(</span>wac.place.2011.v2<span class="p">,</span> wac.place.2011<span class="p">,</span> all <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Take the difference to generate absolute growth numbers</span>
</span><span class='line'><span class="c1"># Columns 4:54 represent the data, 1:3 are the geographic identifiers</span>
</span><span class='line'>wac.2011.2010 <span class="o">&lt;-</span> <span class="kp">cbind</span><span class="p">(</span>wac.place.2011.v2<span class="p">[,</span> <span class="m">4</span><span class="o">:</span><span class="m">54</span><span class="p">]</span> <span class="o">-</span> wac.place.2010.v2<span class="p">[,</span> <span class="m">4</span><span class="o">:</span><span class="m">54</span><span class="p">],</span>
</span><span class='line'>  wac.place.2011.v2<span class="p">[,</span> <span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">])</span>
</span><span class='line'>wac.2010.2009 <span class="o">&lt;-</span> <span class="kp">cbind</span><span class="p">(</span>wac.place.2010.v2<span class="p">[,</span> <span class="m">4</span><span class="o">:</span><span class="m">54</span><span class="p">]</span> <span class="o">-</span> wac.place.2009.v2<span class="p">[,</span> <span class="m">4</span><span class="o">:</span><span class="m">54</span><span class="p">],</span>
</span><span class='line'>  wac.place.2011.v2<span class="p">[,</span> <span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Calculate percentage differences</span>
</span><span class='line'>wac.2011.2010.pct <span class="o">&lt;-</span> <span class="kp">cbind</span><span class="p">((</span>wac.place.2011.v2<span class="p">[,</span> <span class="m">4</span><span class="o">:</span><span class="m">54</span><span class="p">]</span> <span class="o">-</span> wac.place.2010.v2<span class="p">[,</span> <span class="m">4</span><span class="o">:</span><span class="m">54</span><span class="p">])</span><span class="o">/</span>
</span><span class='line'>  wac.place.2010.v2<span class="p">[,</span> <span class="m">4</span><span class="o">:</span><span class="m">54</span><span class="p">],</span> wac.place.2011.v2<span class="p">[,</span> <span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">])</span>
</span><span class='line'>wac.2010.2009.pct <span class="o">&lt;-</span> <span class="kp">cbind</span><span class="p">((</span>wac.place.2010.v2<span class="p">[,</span> <span class="m">4</span><span class="o">:</span><span class="m">54</span><span class="p">]</span> <span class="o">-</span> wac.place.2009.v2<span class="p">[,</span> <span class="m">4</span><span class="o">:</span><span class="m">54</span><span class="p">])</span><span class="o">/</span>
</span><span class='line'>  wac.place.2009.v2<span class="p">[,</span> <span class="m">4</span><span class="o">:</span><span class="m">54</span><span class="p">],</span> wac.place.2011.v2<span class="p">[,</span> <span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>To visualize the percentage changes, I wanted to use a diverging color scheme, preferably derived from the Color Brewer palettes ranging between +/- 100%. My first attempts were not successful, because the default labeling  for the palette associated red with the decreases and blue with the increases as in the following image. Note that, in the ggplot code, <code>i</code> indexes every employment category that I&rsquo;m interested in, <code>threshold</code> separates the top 25 places in the Bay Area from the rest in terms of total employment, and <code>pretty_name</code> was a variable I created that stripped some census identifiers from places (CDP, city, town, etc.), and <code>basemap</code> is a map I created with ggmap. For a Color Brewer diverging palette, we can use <code>scale_fill_distiller()</code> in ggplot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>basemap <span class="o">+</span> geom_polygon<span class="p">(</span>data <span class="o">=</span> places.box.f<span class="p">,</span> aes<span class="p">(</span>x <span class="o">=</span> long<span class="p">,</span> y <span class="o">=</span> lat<span class="p">,</span> group <span class="o">=</span> group<span class="p">,</span>
</span><span class='line'>  fill <span class="o">=</span> <span class="kp">eval</span><span class="p">(</span><span class="kp">parse</span><span class="p">(</span>text <span class="o">=</span> <span class="kp">paste0</span><span class="p">(</span>plot.categories<span class="p">[,</span> <span class="m">1</span><span class="p">][</span>i<span class="p">])))),</span>
</span><span class='line'>  color <span class="o">=</span> grey<span class="p">(</span><span class="m">0.4</span><span class="p">),</span> alpha <span class="o">=</span> <span class="m">0.7</span><span class="p">,</span> lwd <span class="o">=</span> <span class="m">0.1</span><span class="p">)</span> <span class="o">+</span>
</span><span class='line'>  geom_text<span class="p">(</span>data <span class="o">=</span> label_points<span class="p">[</span>label_points<span class="o">$</span>C000 <span class="o">&gt;</span> threshold<span class="p">,</span> <span class="p">],</span> aes<span class="p">(</span>x <span class="o">=</span> long_<span class="p">,</span> y <span class="o">=</span> lat_<span class="p">,</span> label <span class="o">=</span> pretty_name<span class="p">),</span>
</span><span class='line'>    size <span class="o">=</span> <span class="m">2</span><span class="p">,</span> fontface <span class="o">=</span> <span class="m">2</span><span class="p">,</span> color <span class="o">=</span> <span class="s">&quot;yellow&quot;</span><span class="p">)</span> <span class="o">+</span>
</span><span class='line'>  scale_fill_distiller<span class="p">(</span>name <span class="o">=</span> <span class="kp">paste0</span><span class="p">(</span><span class="s">&quot;Change in &quot;</span><span class="p">,</span> plot.categories<span class="p">[,</span> <span class="m">2</span><span class="p">][</span>i<span class="p">],</span> <span class="s">&quot; jobs\n 2010 - 2011&quot;</span><span class="p">),</span> type <span class="o">=</span> <span class="s">&quot;div&quot;</span><span class="p">,</span>
</span><span class='line'>    palette <span class="o">=</span> <span class="s">&quot;RdYlBu&quot;</span><span class="p">,</span> space <span class="o">=</span> <span class="s">&quot;Lab&quot;</span><span class="p">,</span> na.value <span class="o">=</span> <span class="s">&quot;black&quot;</span><span class="p">,</span> limits <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">-1</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> breaks <span class="o">=</span> pretty_breaks<span class="p">(</span>n <span class="o">=</span> <span class="m">10</span><span class="p">),</span>
</span><span class='line'>    guide <span class="o">=</span> <span class="s">&quot;legend&quot;</span><span class="p">)</span> <span class="o">+</span>
</span><span class='line'>  guides<span class="p">(</span>fill <span class="o">=</span> guide_legend<span class="p">(</span>override.aes <span class="o">=</span> <span class="kt">list</span><span class="p">(</span>colour <span class="o">=</span> <span class="kc">NULL</span><span class="p">)))</span> <span class="o">+</span>
</span><span class='line'>  theme_nothing<span class="p">(</span>legend <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span> <span class="o">+</span>
</span><span class='line'>  theme<span class="p">(</span>legend.title <span class="o">=</span> element_text<span class="p">(</span>size <span class="o">=</span> <span class="m">5</span><span class="p">),</span> legend.text <span class="o">=</span> element_text<span class="p">(</span>size <span class="o">=</span> <span class="m">5</span><span class="p">),</span>
</span><span class='line'>    legend.key.size <span class="o">=</span> unit<span class="p">(</span><span class="m">8</span><span class="p">,</span> <span class="s">&quot;points&quot;</span><span class="p">))</span> <span class="o">+</span> coord_map<span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>From which we get this map:
<img class="center" src="http://aakarner.github.io/images/map0_sm.jpg" width="825" height="600" title="image" alt="images"></p>

<p>As mentioned, this has the scale flipped from what we&rsquo;d expect. After substantial poking around, I was unable to find an easy way to flip the colors, leading me ultimately to <code>scale_fill_gradient2()</code> which allows you to manually define your own diverging palette. It&rsquo;s not as pretty as Color Brewer&rsquo;s (since I think ggplot just linearly interpolates colors between the max, mid, and min) but it gets the job done. This code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>basemap <span class="o">+</span> geom_polygon<span class="p">(</span>data <span class="o">=</span> places.box.f<span class="p">,</span> aes<span class="p">(</span>x <span class="o">=</span> long<span class="p">,</span> y <span class="o">=</span> lat<span class="p">,</span> group <span class="o">=</span> group<span class="p">,</span>
</span><span class='line'>  fill <span class="o">=</span> <span class="kp">eval</span><span class="p">(</span><span class="kp">parse</span><span class="p">(</span>text <span class="o">=</span> <span class="kp">paste0</span><span class="p">(</span>plot.categories<span class="p">[,</span> <span class="m">1</span><span class="p">][</span>i<span class="p">])))),</span>
</span><span class='line'>  color <span class="o">=</span> grey<span class="p">(</span><span class="m">0.4</span><span class="p">),</span> alpha <span class="o">=</span> <span class="m">0.7</span><span class="p">,</span> lwd <span class="o">=</span> <span class="m">0.1</span><span class="p">)</span> <span class="o">+</span>
</span><span class='line'>  geom_text<span class="p">(</span>data <span class="o">=</span> label_points<span class="p">[</span>label_points<span class="o">$</span>C000 <span class="o">&gt;</span> threshold<span class="p">,</span> <span class="p">],</span> aes<span class="p">(</span>x <span class="o">=</span> long_<span class="p">,</span> y <span class="o">=</span> lat_<span class="p">,</span> label <span class="o">=</span> pretty_name<span class="p">),</span>
</span><span class='line'>      size <span class="o">=</span> <span class="m">2</span><span class="p">,</span> fontface <span class="o">=</span> <span class="m">2</span><span class="p">,</span> color <span class="o">=</span> <span class="s">&quot;yellow&quot;</span><span class="p">)</span> <span class="o">+</span>
</span><span class='line'>  scale_fill_gradient2<span class="p">(</span>name <span class="o">=</span> <span class="kp">paste0</span><span class="p">(</span><span class="s">&quot;Percent change in &quot;</span><span class="p">,</span> plot.categories<span class="p">[,</span> <span class="m">2</span><span class="p">][</span>i<span class="p">],</span> <span class="s">&quot;\njobs 2010 - 2011&quot;</span><span class="p">),</span>
</span><span class='line'>      limits <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">-1</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> breaks <span class="o">=</span> pretty_breaks<span class="p">(</span>n <span class="o">=</span> <span class="m">10</span><span class="p">),</span> low <span class="o">=</span> <span class="s">&quot;#2C7BB6&quot;</span><span class="p">,</span> mid <span class="o">=</span> <span class="s">&quot;#FFFFBF&quot;</span><span class="p">,</span>
</span><span class='line'>      high <span class="o">=</span> <span class="s">&quot;#A50026&quot;</span><span class="p">,</span> midpoint <span class="o">=</span> <span class="m">0</span><span class="p">,</span> space <span class="o">=</span> <span class="s">&quot;Lab&quot;</span><span class="p">,</span> na.value <span class="o">=</span> <span class="s">&quot;black&quot;</span><span class="p">,</span> guide <span class="o">=</span> <span class="s">&quot;legend&quot;</span><span class="p">)</span> <span class="o">+</span>
</span><span class='line'>  guides<span class="p">(</span>fill <span class="o">=</span> guide_legend<span class="p">(</span>override.aes <span class="o">=</span> <span class="kt">list</span><span class="p">(</span>colour <span class="o">=</span> <span class="kc">NULL</span><span class="p">)))</span> <span class="o">+</span>
</span><span class='line'>  theme_nothing<span class="p">(</span>legend <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span> <span class="o">+</span>
</span><span class='line'>  theme<span class="p">(</span>legend.title <span class="o">=</span> element_text<span class="p">(</span>size <span class="o">=</span> <span class="m">5</span><span class="p">),</span> legend.text <span class="o">=</span> element_text<span class="p">(</span>size <span class="o">=</span> <span class="m">5</span><span class="p">),</span>
</span><span class='line'>      legend.key.size <span class="o">=</span> unit<span class="p">(</span><span class="m">8</span><span class="p">,</span> <span class="s">&quot;points&quot;</span><span class="p">))</span> <span class="o">+</span> coord_map<span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>produces this map:
<img class="center" src="http://aakarner.github.io/images/map1_sm.jpg" width="900" height="600" title="image" alt="images"></p>

<p>Which is much nicer than what we had before.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Hello, World]]></title>
    <link href="http://aakarner.github.io/blog/2015/02/27/Hello-world/"/>
    <updated>2015-02-27T23:36:56-07:00</updated>
    <id>http://aakarner.github.io/blog/2015/02/27/Hello-world</id>
    <content type="html"><![CDATA[<p>I create a lot of code (mostly in R, but some Python too) to conduct my analyses. Most of that code sits on my computer, some of it makes its way to GitHub. I want more of a social outlet to work through issues I&rsquo;m having and to share my successes. This blog should serve that purpose. Thanks for stopping by!</p>
]]></content>
  </entry>
  
</feed>
